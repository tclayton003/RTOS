

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>3.3.3.4. CSP Interfaces &mdash; A3200 Board Support Package 2.6.3 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../../../search.html"/>
    <link rel="top" title="A3200 Board Support Package 2.6.3 documentation" href="../../../../../index.html"/>
        <link rel="up" title="3.3.3. CubeSat Space Protocol" href="libcsp.html"/>
        <link rel="next" title="3.3.3.5. How CSP uses memory" href="memory.html"/>
        <link rel="prev" title="3.3.3.3. Structure" href="structure.html"/> 

  
  <script src="../../../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../../../doc/index.html" class="icon icon-home"> A3200 Board Support Package
          

          
          </a>

          
            
            
              <div class="version">
                2.6.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../../doc/a3200-bsp.html">1. A3200 BSP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../doc/a3200_toolchain.html">2. Programming</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../../../doc/libraries.html">3. Libraries</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../../liba3200/doc/liba3200.html">3.1. A3200 (liba3200)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../libasf/doc/libasf.html">3.2. ASF (libasf)</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../../doc/libgscsp.html">3.3. GomSpace CSP (libgscsp)</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../../doc/introduction.html">3.3.1. Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../doc/commands.html">3.3.2. Commands</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="libcsp.html">3.3.3. CubeSat Space Protocol</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../README.html">3.3.3.1. The Cubesat Space Protocol</a></li>
<li class="toctree-l4"><a class="reference internal" href="history.html">3.3.3.2. History</a></li>
<li class="toctree-l4"><a class="reference internal" href="structure.html">3.3.3.3. Structure</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">3.3.3.4. CSP Interfaces</a></li>
<li class="toctree-l4"><a class="reference internal" href="memory.html">3.3.3.5. How CSP uses memory</a></li>
<li class="toctree-l4"><a class="reference internal" href="protocolstack.html">3.3.3.6. The Protocol Stack</a></li>
<li class="toctree-l4"><a class="reference internal" href="topology.html">3.3.3.7. Network Topology</a></li>
<li class="toctree-l4"><a class="reference internal" href="mtu.html">3.3.3.8. Maximum Transfer Unit</a></li>
<li class="toctree-l4"><a class="reference internal" href="example.html">3.3.3.9. Client and server example</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../libembed/doc/libembed.html">3.4. Embed (libembed)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../libthirdparty/doc/libthirdparty.html">3.5. Thirdparty (libthirdparty)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../libutil/doc/libutil.html">3.6. Utility (libutil)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../doc/tools.html">4. Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../doc/appendix/appendix.html">5. Appendix</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../doc/zrefs.html">6. Bibliography</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../../../doc/index.html">A3200 Board Support Package</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../../../doc/index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../../../../doc/libraries.html">3. Libraries</a> &raquo;</li>
      
          <li><a href="../../../doc/libgscsp.html">3.3. GomSpace CSP (libgscsp)</a> &raquo;</li>
      
          <li><a href="libcsp.html">3.3.3. CubeSat Space Protocol</a> &raquo;</li>
      
    <li>3.3.3.4. CSP Interfaces</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="csp-interfaces">
<h1>3.3.3.4. CSP Interfaces<a class="headerlink" href="#csp-interfaces" title="Permalink to this headline">¶</a></h1>
<p>This is an example of how to implement a new layer-2 interface in CSP. The example is going to show how to create a <cite>csp_if_fifo</cite>, using a set of [named pipes](<a class="reference external" href="http://en.wikipedia.org/wiki/Named_pipe">http://en.wikipedia.org/wiki/Named_pipe</a>). The complete interface example code can be found in <cite>examples/fifo.c</cite>. For an example of a fragmenting interface, see the CAN interface in <cite>src/interfaces/csp_if_can.c</cite>.</p>
<p>CSP interfaces are declared in a <cite>csp_iface_t</cite> structure, which sets the interface nexthop function and name. A maximum transmission unit can also be set, which forces CSP to drop outgoing packets above a certain size. The fifo interface is defined as:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cp">#include</span> <span class="cpf">&lt;csp/csp.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;csp/csp_interface.h&gt;</span><span class="cp"></span>

<span class="n">csp_iface_t</span> <span class="n">csp_if_fifo</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;fifo&quot;</span><span class="p">,</span>
    <span class="p">.</span><span class="n">nexthop</span> <span class="o">=</span> <span class="n">csp_fifo_tx</span><span class="p">,</span>
    <span class="p">.</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">BUF_SIZE</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="section" id="outgoing-traffic">
<h2>3.3.3.4.1. Outgoing traffic<a class="headerlink" href="#outgoing-traffic" title="Permalink to this headline">¶</a></h2>
<p>The nexthop function takes a pointer to a CSP packet and a timeout as parameters. All outgoing packets that are routed to the interface are passed to this function:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">csp_fifo_tx</span><span class="p">(</span><span class="n">csp_packet_t</span> <span class="o">*</span><span class="n">packet</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">write</span><span class="p">(</span><span class="n">tx_channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">));</span>
    <span class="n">csp_buffer_free</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the fifo interface, we simply transmit the header, length field and data using a write to the fifo. CSP does not dictate the wire format, so other interfaces may decide to e.g. ignore the length field if the physical layer provides start/stop flags.</p>
<p>_Important notice: If the transmission succeeds, the interface must free the packet and return 1. If transmission fails, the nexthop function should return 0 and not free the packet, to allow retransmissions by the caller._</p>
</div>
<div class="section" id="incoming-traffic">
<h2>3.3.3.4.2. Incoming traffic<a class="headerlink" href="#incoming-traffic" title="Permalink to this headline">¶</a></h2>
<p>The interface also needs to receive incoming packets and pass it to the CSP protocol stack. In the fifo interface, this is handled by a thread that blocks on the incoming fifo and waits for packets:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="kt">void</span> <span class="o">*</span> <span class="nf">fifo_rx</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">parameters</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">csp_packet_t</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">csp_buffer_get</span><span class="p">(</span><span class="n">BUF_SIZE</span><span class="p">);</span>
    <span class="cm">/* Wait for packet on fifo */</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">rx_channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">BUF_SIZE</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">csp_qfifo_write</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csp_if_fifo</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">csp_buffer_get</span><span class="p">(</span><span class="n">BUF_SIZE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>A new CSP buffer is preallocated with csp_buffer_get(). When data is received, the packet is passed to CSP using <cite>csp_qfifo_write()</cite> and a new buffer is allocated for the next packet. In addition to the received packet, <cite>csp_qfifo_write()</cite> takes two additional arguments:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="kt">void</span> <span class="nf">csp_qfifo_write</span><span class="p">(</span><span class="n">csp_packet_t</span> <span class="o">*</span><span class="n">packet</span><span class="p">,</span> <span class="n">csp_iface_t</span> <span class="o">*</span><span class="n">interface</span><span class="p">,</span> <span class="n">CSP_BASE_TYPE</span> <span class="o">*</span><span class="n">pxTaskWoken</span><span class="p">);</span>
</pre></div>
</div>
<p>The calling interface must be passed in <cite>interface</cite> to avoid routing loops. Furthermore, <cite>pxTaskWoken</cite> must be set to a non-NULL value if the packet is received in an interrupt service routine. If the packet is received in task context, NULL must be passed. ‘pxTaskWoken’ only applies to FreeRTOS systems, and POSIX system should always set the value to NULL.</p>
<p><cite>csp_qfifo_write</cite> will either accept the packet or free the packet buffer, so the interface must never free the packet after passing it to CSP.</p>
</div>
<div class="section" id="initialization">
<h2>3.3.3.4.3. Initialization<a class="headerlink" href="#initialization" title="Permalink to this headline">¶</a></h2>
<p>In order to initialize the interface, and make it available to the router, use the following function found in <cite>csp/csp_interface.h</cite>:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">csp_route_add_if</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csp_if_fifo</span><span class="p">);</span>
</pre></div>
</div>
<p>This actually happens automatically if you try to call <cite>csp_route_add()</cite> with an interface that is unknown to the router. This may however be removed in the future, in order to ensure that all interfaces are initialised before configuring the routing table. The reason is, that some products released in the future may ship with an empty routing table, which is then configured by a routing protocol rather than a static configuration.</p>
<p>In order to setup a manual static route, use the following example where the default route is set to the fifo interface:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">csp_route_set</span><span class="p">(</span><span class="n">CSP_DEFAULT_ROUTE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csp_if_fifo</span><span class="p">,</span> <span class="n">CSP_NODE_MAC</span><span class="p">);</span>
</pre></div>
</div>
<p>All outgoing traffic except loopback, is now passed to the fifo interface’s nexthop function.</p>
</div>
<div class="section" id="building-the-example">
<h2>3.3.3.4.4. Building the example<a class="headerlink" href="#building-the-example" title="Permalink to this headline">¶</a></h2>
<p>The fifo examples can be compiled with:</p>
<div class="highlight-bash"><div class="highlight"><pre>% gcc csp_if_fifo.c -o csp_if_fifo -I&lt;CSP PATH&gt;/include -L&lt;CSP PATH&gt;/build -lcsp -lpthread -lrt
</pre></div>
</div>
<p>The two named pipes are created with:</p>
<div class="highlight-bash"><div class="highlight"><pre>% mkfifo server_to_client client_to_server
</pre></div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="memory.html" class="btn btn-neutral float-right" title="3.3.3.5. How CSP uses memory" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="structure.html" class="btn btn-neutral" title="3.3.3.3. Structure" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2023 GomSpace A/S..

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../../',
            VERSION:'2.6.3',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  false
        };
    </script>
      <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>